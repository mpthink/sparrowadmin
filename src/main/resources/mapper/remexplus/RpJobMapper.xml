<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.think.sparrowadmin.remexplus.mapper.RpJobMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.think.sparrowadmin.remexplus.entity.RpJob">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="remex_job_id" property="remexJobId" />
        <result column="status" property="status" />
        <result column="result" property="result" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, name, remex_job_id, status, result
    </sql>

    <select id="selectJobsByTaskRecordId" resultType="java.util.Map">
        SELECT rp_job.name name, remex_job_id,rp_job.status status,rp_job.result result,rp_task.name task
        FROM rp_job, rp_task, rp_task_record, rp_task_job
        where rp_task.id = rp_task_record.task_id
        and rp_task_record.id = rp_task_job.task_record_id
        and rp_task_record.id = #{id}
        order by rp_job.name
    </select>

    <select id="selectLastJobResult" resultType="java.util.Map">
        SELECT
        sum(case when result = 'Failed' then 1 end) as failed,
        sum(case when result = 'Passed' then 1 end) as passed,
        sum(case when result is null or (result != 'Passed' and result != 'Failed')  then 1 end) as other
        FROM
        rp_job, rp_task_job
        where rp_job.id = rp_task_job.job_id
        and rp_task_job.task_record_id = #{id}
    </select>

</mapper>
